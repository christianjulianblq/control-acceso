<!-- by christian julian gonzalez espinoza -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Control de acceso Secretaría de Desarrollo Económico</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="config.js"></script>

<style>
  :root{
    --primary:#133f66;
    --bg:#201d42;
    --card:rgba(32,29,66,0.9);
    --text:#f2f3f5;
    --text-muted:#bbc0ce;
    --border:#828097;
    --accent:#00ffe1;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:'Orbitron',sans-serif;
    color:var(--text);
    background:var(--bg);
  }

  header{
    position:fixed; top:0; left:0; right:0;
    display:flex; align-items:center; gap:12px;
    padding:8px 14px;
    background:#13112b;
    border-bottom:1px solid var(--border);
    box-shadow:0 0 10px var(--primary);
    z-index:10;
  }
  header img{
    height:44px;
    width:auto;
    border-radius:8px;
  }
  header h1{
    margin:0;
    font-size:1rem;
    color:var(--text);
    text-shadow:0 0 8px var(--accent);
    flex:1;
    text-align:center;
  }
  #logout-btn{
    background:var(--primary);
    color:var(--text);
    border:none;
    padding:6px 12px;
    font-size:.9rem;
    border-radius:6px;
    cursor:pointer;
    display:none;
    transition:0.2s;
  }
  #logout-btn:hover{
    filter:brightness(1.2);
    box-shadow:0 0 10px var(--accent);
  }

  main{
    padding:86px 12px 24px;
    max-width:820px;
    margin:auto;
  }

  .card{
    background:var(--card);
    padding:16px;
    border-radius:14px;
    box-shadow:0 0 12px var(--border);
    border:1px solid var(--border);
  }

  .tab-buttons{
    display:flex;
    gap:8px;
    margin-bottom:12px;
  }
  .tab-buttons button{
    flex:1;
    padding:10px 12px;
    border:none;
    border-radius:10px;
    background:var(--primary);
    color:var(--text);
    cursor:pointer;
    font-size:1rem;
    transition:0.2s;
  }
  .tab-buttons button:hover{
    background:var(--accent);
    color:var(--bg);
  }

  input,select,button,label{ font-size:1rem; }
  input,select{
    width:100%;
    padding:12px;
    margin:6px 0;
    border:1px solid var(--border);
    border-radius:10px;
    background:#2b2855;
    color:var(--text);
  }
  input::placeholder{ color:var(--text-muted); }

  button[type=submit]{
    width:100%;
    background:var(--primary);
    color:var(--text);
    border:none;
    border-radius:10px;
    padding:12px;
    cursor:pointer;
    font-size:1rem;
    margin-top:10px;
  }
  button[type=submit]:hover{
    background:var(--accent);
    color:var(--bg);
  }

  #reader{ width:min(420px, 95vw); margin:14px auto; }
  #scan-btn{
    width:100%;
    padding:12px;
    border:none;
    border-radius:10px;
    background:var(--primary);
    color:var(--text);
    cursor:pointer;
    margin-top:10px;
  }
  #scan-btn:hover{ background:var(--accent); color:var(--bg); }

  #qrcode{ text-align:center; margin-top:12px; }
  #qrcode canvas{ display:block; margin:8px auto; }

  #login-msg{ margin-top:8px; color:#ffb3b3; }
  .helper{ font-size:.92rem; opacity:.85; text-align:center; color:var(--text-muted); }

  .hidden{ display:none !important; }
</style>
</head>
<body>
<header>
  <img src="NuevaHeraldica.png" alt="Logo">
  <h1>Control de acceso Secretaría de Desarrollo Económico</h1>
  <button id="logout-btn" type="button">Cerrar sesión</button>
</header>

<main>
  <div class="card">
    <div class="tab-buttons">
      <button onclick="showTab('registro')">Registrar acceso</button>
      <button onclick="showTab('busqueda')">Buscar registro</button>
      <button onclick="showTab('scanner')">Escanear QR</button>
    </div>

    <section id="registro" class="tab">
      <h2>Nuevo registro</h2>
      <form id="access-form">
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" placeholder="Ingresa el nombre" required>

        <label for="departamento">Departamento</label>
        <select id="departamento" required>
          <option value="">Seleccionar...</option>
          <option value="Oficina del Secretario">Oficina del Secretario</option>
          <option value="Dirección de Impulso Económico">Dirección de Impulso Económico</option>
          <option value="Licencias de Funcionamiento">— Licencias de Funcionamiento</option>
          <option value="Fomento al Empleo">— Fomento al Empleo</option>
          <option value="Dirección de Emprendimiento">Dirección de Emprendimiento</option>
          <option value="Dirección de Desarrollo Rural y Agropecuario">Dirección de Desarrollo Rural y Agropecuario</option>
        </select>

        <button type="submit">Registrar acceso</button>
      </form>
      <div id="qrcode"></div>
    </section>

    <section id="busqueda" class="tab hidden">
      <h2>Buscar por nombre</h2>
      <input type="text" id="search-input" placeholder="Escribe un nombre">
      <button id="search-btn" type="button">Buscar</button>
      <div id="search-result"></div>
    </section>

    <section id="scanner" class="tab hidden">
      <h2>Escanear código QR</h2>
      <div id="reader"></div>
      <button id="scan-btn" type="button">Iniciar escaneo</button>
      <div id="scan-result"></div>
    </section>
  </div>
</main>

<script>
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Cambio de pestañas
function showTab(id){
  document.querySelectorAll('.tab').forEach(t => t.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// Registro de acceso
document.getElementById('access-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const nombre = document.getElementById('nombre').value.trim();
  let departamento = document.getElementById('departamento').value.trim();
  if (departamento === 'Licencias de Funcionamiento' || departamento === 'Fomento al Empleo'){
    departamento = 'Dirección de Impulso Económico (' + departamento + ')';
  }
  const fecha = new Date().toLocaleString('es-MX', {timeZone:'America/Mexico_City'});

  const { data, error } = await supabase.from('accesos').insert([{ nombre, departamento, fecha }]);
  if (error){ alert('Error al registrar: '+error.message); return; }

  const qrData = `Nombre: ${nombre}\nDepto: ${departamento}\nFecha: ${fecha}`;
  document.getElementById('qrcode').innerHTML = '';
  QRCode.toCanvas(document.createElement('canvas'), qrData, {width:180}, (err, canvas)=>{
    if (!err) document.getElementById('qrcode').appendChild(canvas);
  });
  alert('Registro exitoso ✅');
  e.target.reset();
});

// Buscar por nombre
document.getElementById('search-btn').addEventListener('click', async ()=>{
  const nombre = document.getElementById('search-input').value.trim();
  const { data, error } = await supabase.from('accesos').select('*').ilike('nombre', `%${nombre}%`);
  const result = document.getElementById('search-result');
  if (error || !data.length){
    result.innerHTML = '<p class="helper">No se encontraron resultados</p>';
  } else {
    result.innerHTML = data.map(r => `<p><b>${r.nombre}</b> — ${r.departamento}<br><small>${r.fecha}</small></p>`).join('');
  }
});

// Escaneo QR
document.getElementById('scan-btn').addEventListener('click', ()=>{
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:250},
    qr => {
      document.getElementById('scan-result').innerHTML = `<p>${qr}</p>`;
      html5QrCode.stop();
    },
    err => {}
  ).catch(err => console.log(err));
});
</script>
</body>
</html>

